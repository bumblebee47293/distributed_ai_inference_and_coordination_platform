openapi: 3.0.3
info:
  title: AI Inference Platform - API Gateway
  description: |
    REST API for the AI Inference Platform API Gateway.

    This service provides:
    - Real-time inference requests
    - Batch inference job submission
    - Job status monitoring
    - Authentication and rate limiting

    ## Authentication
    All endpoints require authentication via Bearer token or API key.

    Use `Authorization: Bearer demo-token` for testing.

  version: 1.0.0
  contact:
    name: API Support
    email: support@aiplatform.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.aiplatform.com
    description: Production server

tags:
  - name: Inference
    description: Real-time and batch inference operations
  - name: Jobs
    description: Batch job management
  - name: Health
    description: Service health and metrics

security:
  - BearerAuth: []
  - ApiKeyAuth: []

paths:
  /v1/infer:
    post:
      tags:
        - Inference
      summary: Perform real-time inference
      description: |
        Execute a real-time inference request for a specific model.

        The request is routed through the Model Router to the appropriate
        Inference Orchestrator, which communicates with Triton Inference Server.

      operationId: realtimeInference
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InferenceRequest"
            examples:
              resnet18:
                summary: ResNet-18 image classification
                value:
                  model: resnet18
                  version: "1"
                  input:
                    data: [1.0, 2.0, 3.0, 4.0]
              bert:
                summary: BERT text classification
                value:
                  model: bert
                  version: "2"
                  input:
                    text: "This is a sample text"
      responses:
        "200":
          description: Inference successful
          headers:
            X-Trace-ID:
              description: Distributed tracing ID
              schema:
                type: string
            X-Request-ID:
              description: Unique request identifier
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InferenceResponse"
              examples:
                success:
                  summary: Successful inference
                  value:
                    prediction: [0.1, 0.9, 0.0, 0.0]
                    model: resnet18
                    version: "1"
                    latency_ms: 145
                    timestamp: "2024-01-15T10:30:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalError"

  /v1/batch:
    post:
      tags:
        - Jobs
      summary: Submit batch inference job
      description: |
        Submit a batch inference job for asynchronous processing.

        The job is queued in Kafka and processed by the Batch Worker service.
        Results are stored in MinIO and accessible via the returned URL.

      operationId: submitBatchJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BatchJobRequest"
            examples:
              small_batch:
                summary: Small batch (3 items)
                value:
                  model: resnet18
                  version: "1"
                  inputs:
                    - data: [1.0, 2.0, 3.0]
                    - data: [4.0, 5.0, 6.0]
                    - data: [7.0, 8.0, 9.0]
      responses:
        "202":
          description: Job accepted for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchJobResponse"
              example:
                job_id: "job-123e4567-e89b-12d3-a456-426614174000"
                status: "pending"
                message: "Job submitted successfully"
                created_at: "2024-01-15T10:30:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"

  /v1/batch/{jobId}:
    get:
      tags:
        - Jobs
      summary: Get batch job status
      description: Retrieve the current status and progress of a batch job
      operationId: getBatchJobStatus
      parameters:
        - name: jobId
          in: path
          required: true
          description: Unique job identifier
          schema:
            type: string
            format: uuid
          example: "job-123e4567-e89b-12d3-a456-426614174000"
      responses:
        "200":
          description: Job status retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchJobStatus"
              examples:
                pending:
                  summary: Job pending
                  value:
                    job_id: "job-123e4567-e89b-12d3-a456-426614174000"
                    status: "pending"
                    progress: 0.0
                    total: 100
                    completed: 0
                    created_at: "2024-01-15T10:30:00Z"
                processing:
                  summary: Job processing
                  value:
                    job_id: "job-123e4567-e89b-12d3-a456-426614174000"
                    status: "processing"
                    progress: 0.45
                    total: 100
                    completed: 45
                    created_at: "2024-01-15T10:30:00Z"
                    updated_at: "2024-01-15T10:32:00Z"
                completed:
                  summary: Job completed
                  value:
                    job_id: "job-123e4567-e89b-12d3-a456-426614174000"
                    status: "completed"
                    progress: 1.0
                    total: 100
                    completed: 100
                    result_url: "https://minio.aiplatform.com/results/job-123.json"
                    created_at: "2024-01-15T10:30:00Z"
                    updated_at: "2024-01-15T10:35:00Z"
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the service is healthy and ready to accept requests
      operationId: healthCheck
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: "healthy"
                service: "api-gateway"
                version: "1.0.0"
                timestamp: "2024-01-15T10:30:00Z"

  /metrics:
    get:
      tags:
        - Health
      summary: Prometheus metrics
      description: Expose Prometheus metrics for monitoring
      operationId: getMetrics
      security: []
      responses:
        "200":
          description: Metrics in Prometheus format
          content:
            text/plain:
              example: |
                # HELP http_requests_total Total HTTP requests
                # TYPE http_requests_total counter
                http_requests_total{method="POST",path="/v1/infer",status="200"} 1234

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    InferenceRequest:
      type: object
      required:
        - model
        - version
        - input
      properties:
        model:
          type: string
          description: Model name
          example: "resnet18"
        version:
          type: string
          description: Model version
          example: "1"
        input:
          type: object
          description: Input data (format depends on model)
          additionalProperties: true
          example:
            data: [1.0, 2.0, 3.0, 4.0]

    InferenceResponse:
      type: object
      properties:
        prediction:
          type: array
          items:
            type: number
          description: Model prediction output
          example: [0.1, 0.9, 0.0, 0.0]
        model:
          type: string
          example: "resnet18"
        version:
          type: string
          example: "1"
        latency_ms:
          type: integer
          description: Inference latency in milliseconds
          example: 145
        timestamp:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    BatchJobRequest:
      type: object
      required:
        - model
        - version
        - inputs
      properties:
        model:
          type: string
          description: Model name
          example: "resnet18"
        version:
          type: string
          description: Model version
          example: "1"
        inputs:
          type: array
          description: Array of input data
          minItems: 1
          maxItems: 10000
          items:
            type: object
            additionalProperties: true
          example:
            - data: [1.0, 2.0, 3.0]
            - data: [4.0, 5.0, 6.0]

    BatchJobResponse:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          description: Unique job identifier
          example: "job-123e4567-e89b-12d3-a456-426614174000"
        status:
          type: string
          enum: [pending, processing, completed, failed]
          example: "pending"
        message:
          type: string
          example: "Job submitted successfully"
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    BatchJobStatus:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          example: "job-123e4567-e89b-12d3-a456-426614174000"
        status:
          type: string
          enum: [pending, processing, completed, failed]
          example: "processing"
        progress:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Progress as a fraction (0.0 to 1.0)
          example: 0.45
        total:
          type: integer
          description: Total number of items
          example: 100
        completed:
          type: integer
          description: Number of completed items
          example: 45
        result_url:
          type: string
          format: uri
          description: URL to download results (when completed)
          example: "https://minio.aiplatform.com/results/job-123.json"
        error_message:
          type: string
          description: Error message (if failed)
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-15T10:32:00Z"

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          example: "healthy"
        service:
          type: string
          example: "api-gateway"
        version:
          type: string
          example: "1.0.0"
        timestamp:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: "Invalid request"
        code:
          type: string
          description: Error code
          example: "INVALID_INPUT"
        details:
          type: object
          additionalProperties: true
          description: Additional error details

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Invalid request body"
            code: "INVALID_INPUT"

    Unauthorized:
      description: Unauthorized - missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Missing or invalid authentication token"
            code: "UNAUTHORIZED"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Model not found"
            code: "NOT_FOUND"

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          description: Request limit per window
          schema:
            type: integer
        X-RateLimit-Remaining:
          description: Remaining requests in current window
          schema:
            type: integer
        X-RateLimit-Reset:
          description: Time when the rate limit resets (Unix timestamp)
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Rate limit exceeded"
            code: "RATE_LIMIT_EXCEEDED"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
